-- 稳健版翻译系统
print("🚀 开始加载稳健版翻译系统...")

-- 基础翻译表
local Translations = {
    ["BronxWare 99 Nights"] = "布朗克斯软件 99夜",
    ["Main"] = "主界面",
    ["Auto"] = "自动",
    ["Teleport Options"] = "传送选项",
    ["Bring Items"] = "获取物品",
    ["Player Options"] = "玩家选项",
    ["Codmode"] = "上帝模式",
    ["Spectate Players"] = "观察玩家",
    ["Fly (with Noclip)"] = "飞行（附带穿墙）",
    ["Fly Speed"] = "飞行速度",
    ["80 studs/sec"] = "80 罗布/秒",
    ["Walkspeed"] = "行走速度",
    ["16 Speed"] = "16 速度",
    ["呼出/隐藏鼠标"] = "呼出/隐藏鼠标",
    ["Instant Prompts"] = "即时提示",
    ["Auto Scrap Items"] = "自动拆解物品",
    ["Auto Fuel Fire"] = "自动添加燃料",
    ["Auto Crock Pot Main"] = "自动炖锅",
    ["Auto Cook"] = "自动烹饪",
    ["Auto Consume Food"] = "自动食用食物",
    ["Auto Chop Trees"] = "自动砍树",
    ["Auto Chop"] = "自动砍伐",
    ["Chop Range"] = "砍伐范围",
    ["100 studs"] = "100 罗布",
    ["Auto Plant Trees"] = "自动种植树木",
    ["Use auto chop then click auto plant trees and wait for it to load then it will auto plant"] = "使用自动砍伐后点击自动种树，等待加载完成即可自动种植",
    ["Auto Plant Saplings in Circle"] = "圆形自动种植树苗",
    ["Planting Radius"] = "种植半径",
    ["Tree Spacing"] = "树木间距",
    ["3.5 studs"] = "3.5 罗布",
    ["Chest Selector"] = "箱子选择器",
    ["None"] = "无",
    ["Volcanic Chest1"] = "火山箱子1",
    ["Refresh Chest List"] = "刷新箱子列表",
    ["Teleport To Chest"] = "传送到箱子",
    ["Player Teleport"] = "玩家传送",
    ["Select Player"] = "选择玩家",
    ["Refresh Player List"] = "刷新玩家列表",
    ["Selective Player"] = "选择玩家",
    ["Anvil Teleports"] = "铁砧传送",
    ["Teleport Location"] = "传送位置",
    ["Anvil Front"] = "铁砧前方",
    ["Teleport"] = "传送",
    ["Kids Teleport"] = "孩子传送",
    ["Teleport to Dino Kid"] = "传送到恐龙孩子",
    ["Teleport to Kraken Kid"] = "传送到海怪孩子",
    ["Teleport to Squid Kid"] = "传送到乌贼孩子",
    ["Teleport to Koala Kid"] = "传送到考拉孩子",
    ["Item Category"] = "物品分类",
    ["Fuel"] = "燃料",
    ["Pelt"] = "毛皮",
    ["Seeds"] = "种子",
    ["Armour"] = "盔甲",
    ["Select Item"] = "选择物品",
    ["停止/隐藏图标"] = "停止/隐藏图标",
    ["Chair"] = "椅子",
    ["Biofuel"] = "生物燃料",
    ["Coal"] = "煤炭",
    ["Food"] = "食物",
    ["Ammo"] = "弹药",
    ["Scrap"] = "废料",
    ["Fuel Canister"] = "燃料罐",
    ["Oil Barrel"] = "油桶",
    ["Log"] = "原木",
    ["Sacks"] = "袋子",
    ["Healing"] = "治疗",
    ["Wolf Corpse"] = "狼尸体",
    ["Alpha Wolf Corpse"] = "头狼尸体",
    ["Bear Corpse"] = "熊尸体",
    ["Sapling"] = "树苗",
    ["Bring Selected Item"] = "获取选定物品",
    ["Fishing Options"] = "钓鱼选项",
    ["Instant Catch"] = "即时捕获",
    ["Fishable Area ESP"] = "可钓鱼区域ESP",
    ["Fishing Zone"] = "钓鱼区域",
    ["Water (Zone #1)"] = "水域（区域 #1）",
    ["Water (Zone #2)"] = "水域（区域 #2）",
    ["Water (Zone #3)"] = "水域（区域 #3）",
    ["Teleport to Zone"] = "传送到区域",
    ["Refresh Zones"] = "刷新区域",
    ["Teleport to Fishing Hut"] = "传送到钓鱼小屋",
}

-- 创建状态监控UI
local function createStatusUI()
    print("🖥️ 创建状态监控UI...")
    
    local players = game:GetService("Players")
    local player = players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "TranslationStatusUI"
    screenGui.Parent = playerGui
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 350, 0, 200)
    mainFrame.Position = UDim2.new(0, 10, 0, 10)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    mainFrame.BorderSizePixel = 2
    mainFrame.BorderColor3 = Color3.fromRGB(100, 100, 255)
    mainFrame.Parent = screenGui
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(60, 60, 100)
    title.Text = "🔧 翻译系统监控面板"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextScaled = true
    title.Parent = mainFrame
    
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, 0, 0, 120)
    statusLabel.Position = UDim2.new(0, 0, 0, 30)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "系统启动中..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    statusLabel.TextScaled = true
    statusLabel.TextWrapped = true
    statusLabel.Parent = mainFrame
    
    local buttonFrame = Instance.new("Frame")
    buttonFrame.Size = UDim2.new(1, 0, 0, 50)
    buttonFrame.Position = UDim2.new(0, 0, 0, 150)
    buttonFrame.BackgroundTransparency = 1
    buttonFrame.Parent = mainFrame
    
    local loadButton = Instance.new("TextButton")
    loadButton.Size = UDim2.new(0.45, 0, 0.8, 0)
    loadButton.Position = UDim2.new(0.025, 0, 0.1, 0)
    loadButton.BackgroundColor3 = Color3.fromRGB(0, 150, 50)
    loadButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    loadButton.Text = "加载外部脚本"
    loadButton.Parent = buttonFrame
    
    local translateButton = Instance.new("TextButton")
    translateButton.Size = UDim2.new(0.45, 0, 0.8, 0)
    translateButton.Position = UDim2.new(0.525, 0, 0.1, 0)
    translateButton.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
    translateButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    translateButton.Text = "执行翻译"
    translateButton.Parent = buttonFrame
    
    return {
        ScreenGui = screenGui,
        StatusLabel = statusLabel,
        LoadButton = loadButton,
        TranslateButton = translateButton
    }
end

-- 简化的翻译函数
local translationCache = {}
local function translateText(text)
    if not text or type(text) ~= "string" then return text end
    if translationCache[text] then return translationCache[text] end
    
    if Translations[text] then
        translationCache[text] = Translations[text]
        print("✅ 翻译: " .. text .. " -> " .. Translations[text])
        return Translations[text]
    end
    
    return text
end

-- GUI扫描函数
local processedElements = {}
local function scanAndTranslateGui(parent, depth)
    if depth > 10 then return end -- 防止无限递归
    
    for _, child in ipairs(parent:GetChildren()) do
        -- 检查是否是文本元素
        if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") then
            if not processedElements[child] and child.Text and child.Text ~= "" then
                local translated = translateText(child.Text)
                if translated ~= child.Text then
                    pcall(function()
                        child.Text = translated
                        processedElements[child] = true
                    end)
                end
            end
        end
        
        -- 递归扫描子元素
        if #child:GetChildren() > 0 then
            scanAndTranslateGui(child, depth + 1)
        end
    end
end

-- 加载外部脚本函数
local function loadExternalScript(updateStatus)
    updateStatus("🔄 正在加载外部脚本...")
    print("🔄 加载外部脚本...")
    
    local success, err = pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Seriously56/99-Nights/refs/heads/main/99%20nights", true))()
    end)
    
    if success then
        updateStatus("✅ 外部脚本加载成功!\n等待界面创建...")
        print("✅ 外部脚本加载成功")
        
        -- 等待界面创建
        for i = 1, 10 do
            updateStatus("✅ 外部脚本加载成功!\n等待界面创建... (" .. i .. "/10)")
            task.wait(1)
        end
        
        return true
    else
        updateStatus("❌ 外部脚本加载失败:\n" .. tostring(err))
        print("❌ 外部脚本加载失败: " .. tostring(err))
        return false
    end
end

-- 执行翻译函数
local function executeTranslation(updateStatus)
    updateStatus("🔍 扫描并翻译界面...")
    print("🔍 开始扫描界面...")
    
    -- 扫描CoreGui
    local coreGui = game:GetService("CoreGui")
    scanAndTranslateGui(coreGui, 0)
    
    -- 扫描PlayerGui
    local players = game:GetService("Players")
    local player = players.LocalPlayer
    local playerGui = player:FindFirstChild("PlayerGui")
    if playerGui then
        scanAndTranslateGui(playerGui, 0)
    end
    
    -- 扫描Workspace中的GUI
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("SurfaceGui") or obj:IsA("BillboardGui") then
            scanAndTranslateGui(obj, 0)
        end
    end
    
    local translatedCount = 0
    for _ in pairs(processedElements) do
        translatedCount = translatedCount + 1
    end
    
    updateStatus("✅ 翻译完成!\n已翻译 " .. translatedCount .. " 个元素")
    print("✅ 翻译完成! 已翻译 " .. translatedCount .. " 个元素")
end

-- 主初始化函数
local function main()
    print("🚀 主初始化开始...")
    
    -- 创建状态UI
    local ui = createStatusUI()
    
    -- 更新状态函数
    local function updateStatus(message)
        pcall(function()
            ui.StatusLabel.Text = message
        end)
        print("📢 " .. message)
    end
    
    updateStatus("🟢 系统就绪\n点击按钮开始操作")
    
    -- 设置按钮事件
    ui.LoadButton.MouseButton1Click:Connect(function()
        task.spawn(function()
            loadExternalScript(updateStatus)
        end)
    end)
    
    ui.TranslateButton.MouseButton1Click:Connect(function()
        task.spawn(function()
            executeTranslation(updateStatus)
        end)
    end)
    
    -- 自动尝试加载外部脚本
    task.spawn(function()
        task.wait(3)
        updateStatus("⏳ 3秒后自动尝试加载外部脚本...")
        task.wait(3)
        
        local success = loadExternalScript(updateStatus)
        
        if success then
            task.wait(2)
            updateStatus("⏳ 自动执行翻译...")
            task.wait(1)
            executeTranslation(updateStatus)
        end
    end)
    
    print("🎉 主初始化完成")
end

-- 启动系统
task.spawn(main)

print("🎯 稳健版翻译系统加载完成")
